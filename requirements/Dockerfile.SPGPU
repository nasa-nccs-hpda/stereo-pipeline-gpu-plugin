FROM nasanccs/spgpu-baselibs:latest

# ----------------------------------------------------------------------------
# https://stereopipeline.readthedocs.io/en/latest/stereo_algorithms.html#adding-new-algorithms-to-asp
# ----------------------------------------------------------------------------

RUN echo "Search for this in the log file to see what happened."

# ----------------------------------------------------------------------------
# Paths
# ----------------------------------------------------------------------------
ARG ilabSource="/usr/local/ilab"
ARG repoName="stereo-pipeline-gpu-plugin"
ARG repoDir=${ilabSource}/${repoName}
ARG buildDir=${ilabSource}/"buildDir"
ARG stereoPipelineDir="/opt/StereoPipeline"
ARG plugInDir="plugins/stereo"

# ----------------------------------------------------------------------------
# To get the GPU plug-in files, the repository must be cloned.
# ----------------------------------------------------------------------------
RUN mkdir -p ${ilabSource} && \
    git clone --single-branch --branch main \
		https://github.com/nasa-nccs-hpda/${repoName} \
        ${repoDir}

# ----------------------------------------------------------------------------
# Compile the BM plug in, copy it to Stereo Pipeline and
# update plugin_list.txt.
# ----------------------------------------------------------------------------
ARG name="opencv_bm_gpu"
RUN mkdir ${buildDir}

RUN g++ ${repoDir}/spgpu/correlator/${name}.cpp -o ${buildDir}/${name} -I/usr/local/include/opencv4 -I/usr/include/gdal -L/usr/local/lib -lopencv_core -lopencv_imgproc -lopencv_highgui -lopencv_calib3d -lopencv_cudaimgproc -lopencv_cudastereo -lopencv_imgcodecs -lgdal -DHAVE_OPENCV_CUDA=1

ARG binDir=${stereoPipelineDir}/${plugInDir}/${name}/bin
ARG bin
RUN mkdir -p ${binDir}
RUN cp ${buildDir}/${name} $binDir

#  opencv_bm_gpu  plugins/stereo/opencv_bm_gpu/bin/opencv_bm_gpu  plugins/stereo/opencv_bm_gpu/lib
# printf "\ttest\thi/exec\thi/lib\n" >> plugin_list.txt
RUN printf "  %s%s%s\n" "$name" "${plugInDir}/${name}/bin/${name}" "${plugInDir}/lib" >> ${stereoPipelineDir}/${plugInDir}/plugin_list.txt

# ----------------------------------------------------------------------------
# Remove the cloned repository.
# ----------------------------------------------------------------------------

HEALTHCHECK NONE
ENTRYPOINT []
CMD ["/bin/bash"]
